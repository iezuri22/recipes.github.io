<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .button-hover {
      transition: opacity 0.2s;
    }

    .button-hover:hover {
      opacity: 0.8;
    }

    .card-hover {
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .app-title {
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto"></div>
<script>
/* =====================================================
   LocalStorage-backed SDK (Canva replacement)
   ===================================================== */

const STORAGE_KEY = 'meal_planner_data_v1';

function loadStore() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  } catch {
    return [];
  }
}

function saveStore(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

window.dataSdk = {
  _data: loadStore(),
  _handler: null,

  async init(handler) {
    this._handler = handler;
    handler.onDataChanged(this._data);
    return { isOk: true };
  },

  async create(item) {
    this._data.push(item);
    saveStore(this._data);
    this._handler?.onDataChanged(this._data);
    return { isOk: true };
  },

  async update(item) {
    const i = this._data.findIndex(d => d.id === item.id);
    if (i !== -1) this._data[i] = item;
    saveStore(this._data);
    this._handler?.onDataChanged(this._data);
    return { isOk: true };
  },

  async delete(item) {
    this._data = this._data.filter(d => d.id !== item.id);
    saveStore(this._data);
    this._handler?.onDataChanged(this._data);
    return { isOk: true };
  }
};

/* elementSdk stub so existing config logic does not break */
window.elementSdk = {
  config: {},
  async init() {},
  setConfig() {}
};
</script>

<script>
    // Default configuration
    const defaultConfig = {
      background_color: "#1a1a2e",
      surface_color: "#16213e",
      text_color: "#eaeaea",
      primary_action_color: "#0f3460",
      secondary_action_color: "#533483",
      font_family: "sans-serif",
      font_size: 16,
      app_title: "Meal Planner",
      recipes_label: "My Recipes",
      weekly_plan_label: "Weekly Plan",
      grocery_list_label: "Grocery List"
    };

    // State variables
    let recipes = [];
    let planData = [];
    let mealSelections = [];
    let groceryItems = [];
    let currentView = 'home';
    let editingRecipe = null;
    let selectedDayForRecipe = null;
    let selectedMealForRecipe = null;
    let selectedCategory = 'Breakfast';
    let searchTerm = '';
    let filterFavorites = false;
    let selectedGroceryDate = null;
    let selectedGroceryMeal = null;
    let selectedGroceryRecipeId = null;
    let currentWeekStartDate = getMonday(new Date()).toISOString().split('T')[0];
    let isLoading = false;
    let selectedRecipeViewId = null;

    // ---- Recipe editor fields (NEW) ----
    let recipeForm = null;
    const ING_GROUPS = ['Produce','Meat','Seafood','Dairy','Pantry','Frozen','Bakery','Other'];

    // Helper functions for recipe data
    function recipeThumb(r){
      const u=(r&&r.image_url||'').trim();
      return u?u:'';
    }
    function esc(s){return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");}
    function recipeIngList(r){
      if(!r) return [];
      if(Array.isArray(r.ingredientsRows)&&r.ingredientsRows.length){
        return r.ingredientsRows
          .map(x=>({qty:(x.qty||'').trim(),unit:(x.unit||'').trim(),name:(x.name||'').trim(),group:(x.group||'Other')}))
          .filter(x=>x.name);
      }
      const t=(r.ingredients||'').trim();
      if(!t) return [];
      return parseIngredients(t).map(x=>({qty:x.quantity||'',unit:x.unit||'',name:x.name||'',group:'Other'})).filter(x=>x.name);
    }
    function ingKey(name){return normalizeIngredient(name);}

    function newRecipeDraft() {
      return {
        type: 'recipe',
        title: '',
        category: 'Breakfast',
        recipe_url: '',
        image_url: '',
        tags: '',
        notes: '',
        instructions: '',
        ingredientsRows: [{ qty:'', unit:'', name:'', group:'Produce' }]
      };
    }

    function ensureRecipeForm() {
      if (!recipeForm) recipeForm = newRecipeDraft();
      if (!Array.isArray(recipeForm.ingredientsRows)) recipeForm.ingredientsRows = [];
      if (recipeForm.ingredientsRows.length === 0) recipeForm.ingredientsRows.push({qty:'',unit:'',name:'',group:'Produce'});
    }

    function setRecipeField(field, value) {
      ensureRecipeForm();
      recipeForm[field] = value;
    }

    function addIngRow() {
      ensureRecipeForm();
      recipeForm.ingredientsRows.push({qty:'',unit:'',name:'',group:'Produce'});
      render();
    }

    function delIngRow(i) {
      ensureRecipeForm();
      recipeForm.ingredientsRows.splice(i,1);
      if (recipeForm.ingredientsRows.length === 0) addIngRow();
      render();
    }

    function setIng(i, field, value) {
      ensureRecipeForm();
      recipeForm.ingredientsRows[i][field] = value;
    }

    function openNewRecipe() {
      recipeForm = newRecipeDraft();
      currentView = 'recipe-edit';
      render();
    }

    function openEditRecipe(recipeId) {
      const r = recipes.find(x => x.id === recipeId || x.__backendId === recipeId);
      if (!r) return;

      const rows = Array.isArray(r.ingredientsRows) ? r.ingredientsRows : [];
      recipeForm = {
        ...newRecipeDraft(),
        ...r,
        ingredientsRows: rows.length ? rows : [{qty:'',unit:'',name:'',group:'Produce'}]
      };

      currentView = 'recipe-edit';
      render();
    }

    function closeRecipeEditor() {
      recipeForm = null;
      currentView = 'recipes';
      render();
    }

    function openRecipeView(id){
      selectedRecipeViewId = id;
      currentView = 'recipe-view';
      render();
    }

    function renderRecipeView(){
      const r = getRecipeById(selectedRecipeViewId);
      if(!r) return `<div class="p-6" style="color:${config.text_color};">Recipe not found.</div>`;

      const img = recipeThumb(r);
      const url = (r.recipe_url||'').trim();
      const tags = (r.tags||'').trim();
      const notes = (r.notes||'').trim();
      const instructions = (r.instructions||'').trim();

      const rows = Array.isArray(r.ingredientsRows) ? r.ingredientsRows : [];
      const grouped = {};
      rows.forEach(x=>{
        const g=(x.group||'Other'); if(!grouped[g]) grouped[g]=[];
        grouped[g].push(x);
      });
      const groupOrder = Object.keys(grouped);

      return `
      <div class="p-6 max-w-5xl mx-auto">
        <div class="flex items-center justify-between mb-4">
          <button type="button" onclick="currentView='recipes'; render();"
            class="px-4 py-2 rounded button-hover"
            style="background:${config.secondary_action_color}; color:${config.text_color};">← Back</button>

          <div class="flex gap-2">
            <button type="button" onclick="openEditRecipe('${r.__backendId||r.id}')"
              class="px-4 py-2 rounded button-hover"
              style="background:${config.primary_action_color}; color:${config.text_color};">Edit</button>
          </div>
        </div>

        <div class="rounded p-5" style="background:${config.surface_color};">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-bold" style="color:${config.text_color}; font-size:${config.font_size*1.7}px;">
                ${esc(r.title)}
              </div>
              <div style="color:${config.text_color}; opacity:.7;">${esc(r.category||'')}</div>
            </div>
            <button type="button" onclick="toggleFavorite('${r.__backendId||r.id}')" class="text-2xl">
              ${r.favorite?'⭐':'☆'}
            </button>
          </div>

          ${img?`<div class="mt-4 rounded overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
            <img src="${esc(img)}" style="width:100%; max-height:260px; object-fit:cover;" />
          </div>`:''}

          ${url?`<div class="mt-4">
            <a href="${esc(url)}" target="_blank" rel="noopener noreferrer"
              style="color:${config.text_color}; text-decoration:underline; opacity:.9;">
              Open recipe link →
            </a>
          </div>`:''}

          ${tags?`<div class="mt-4" style="color:${config.text_color}; opacity:.85;">
            <span class="font-semibold">Tags:</span> ${esc(tags)}
          </div>`:''}

          ${groupOrder.length?`
            <div class="mt-6">
              <div class="font-semibold mb-2" style="color:${config.text_color};">Ingredients</div>
              ${groupOrder.map(g=>`
                <div class="mb-4">
                  <div class="font-semibold" style="color:${config.text_color}; opacity:.8;">${esc(g)}</div>
                  <ul class="mt-2" style="color:${config.text_color}; opacity:.9;">
                    ${grouped[g].map(x=>`<li>• ${esc((x.qty||'').trim())} ${esc((x.unit||'').trim())} ${esc((x.name||'').trim())}</li>`).join('')}
                  </ul>
                </div>
              `).join('')}
            </div>`:''}

          <div class="mt-6">
            <div class="font-semibold mb-2" style="color:${config.text_color};">Step-by-step instructions</div>
            ${instructions?`
              <div class="rounded p-4" style="background:rgba(255,255,255,0.03); color:${config.text_color}; white-space:pre-wrap;">
                ${esc(instructions)}
              </div>`:`
              <div style="color:${config.text_color}; opacity:.6;">
                No instructions saved yet. Add them in Edit.
              </div>`}
          </div>

          ${notes?`
            <div class="mt-6">
              <div class="font-semibold mb-2" style="color:${config.text_color};">Notes</div>
              <div class="rounded p-4" style="background:rgba(255,255,255,0.03); color:${config.text_color}; white-space:pre-wrap;">
                ${esc(notes)}
              </div>
            </div>`:''}
        </div>
      </div>`;
    }

    async function saveRecipeForm() {
      ensureRecipeForm();

      const title = (recipeForm.title||'').trim();
      const cat = (recipeForm.category||'').trim();
      const url = (recipeForm.recipe_url||'').trim();

      if (!title) return showError('Recipe Title is required.');
      if (!cat) return showError('Category is required.');
      if (!url) return showError('Recipe URL is required.');

      const rows = (recipeForm.ingredientsRows||[])
        .map(r=>({qty:(r.qty||'').trim(), unit:(r.unit||'').trim(), name:(r.name||'').trim(), group:r.group||'Other'}))
        .filter(r=>r.name);

      if (!rows.length) return showError('Add at least 1 ingredient.');

      const payload = {
        ...recipeForm,
        title,
        category: cat,
        recipe_url: url,
        image_url: (recipeForm.image_url||'').trim(),
        tags: (recipeForm.tags||'').trim(),
        notes: (recipeForm.notes||'').trim(),
        instructions: (recipeForm.instructions||'').trim(),
        ingredientsRows: rows
      };

      let res;
      try {
        if (payload.id) {
          res = await window.dataSdk.update(payload);
        } else {
          payload.id = `recipe_${Date.now()}_${Math.random().toString(36).slice(2)}`;
          res = await window.dataSdk.create(payload);
        }
      } catch (e) {
        console.error(e);
        res = { isOk:false };
      }

      if (!res || !res.isOk) return showError('Failed to save recipe.');
      closeRecipeEditor();
    }

    // Get Monday of current week
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    // Get week dates
    function getWeekDates(startDate) {
      const dates = [];
      const start = new Date(startDate);
      for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);
      }
      return dates;
    }

    // Format date for display
    function formatDateDisplay(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // Get recipe by ID
    function getRecipeById(id) {
      return recipes.find(r => r.__backendId === id || r.id === id);
    }

    // Normalize ingredient name for comparison
    function normalizeIngredient(name) {
      return name.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
    }

    // Parse ingredients from text
    function parseIngredients(ingredientsText) {
      const lines = ingredientsText.split('\n').filter(line => line.trim());
      return lines.map(line => {
        const match = line.match(/^([\d./]+)?\s*([a-zA-Z]*)\s*(.+)$/);
        if (match) {
          return {
            quantity: match[1] || '1',
            unit: match[2] || '',
            name: match[3]
          };
        }
        return { quantity: '1', unit: '', name: line };
      });
    }

    // Get planned meals for the current week
    function getPlannedMealsForWeek(weekStart) {
      const weekDates = getWeekDates(weekStart);
      const meals = [];
      
      weekDates.forEach(date => {
        const plan = planData.find(p => p.date === date);
        if (plan) {
          ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
            if (plan[mealType]) {
              const recipe = getRecipeById(plan[mealType]);
              if (recipe) {
                meals.push({
                  date: date,
                  meal: mealType.charAt(0).toUpperCase() + mealType.slice(1),
                  recipeId: plan[mealType],
                  recipeTitle: recipe.title
                });
              }
            }
          });
        }
      });
      
      return meals;
    }

    // Get grocery list
    function getGroceryList(){
      const aggregated={};

      mealSelections.forEach(sel=>{
        const parts=sel.id.split('_');
        const date=parts[1];
        const meal=parts[2];
        const plan=planData.find(p=>p.date===date);
        if(!plan) return;

        const mealKey=(meal||'').toLowerCase();
        const recipeId=plan[mealKey];
        if(!recipeId) return;

        const r=getRecipeById(recipeId);
        if(!r) return;

        let keys=[];
        try{keys=JSON.parse(sel.includedIngredientKeys||'[]');}catch(e){keys=[];}

        recipeIngList(r).forEach(ing=>{
          const k=ingKey(ing.name);
          if(!keys.includes(k)) return;

          if(!aggregated[k]){
            aggregated[k]={name:ing.name, quantity:(ing.qty||''), unit:(ing.unit||''), checked:false};
          }
        });
      });

      Object.keys(aggregated).forEach(k=>{
        const gi=groceryItems.find(x=>x.ingredientKey===k);
        aggregated[k].checked=gi?!!gi.checked:false;
      });

      return Object.values(aggregated);
    }

    // Data handler for SDK
    const dataHandler = {
      onDataChanged(data) {
        recipes = data.filter(d => d.id && d.id.startsWith('recipe_'));
        planData = data.filter(d => d.date && d.id && d.id.startsWith('plan_'));
        mealSelections = data.filter(d => d.id && d.id.startsWith('mealSel_'));
        groceryItems = data.filter(d => d.ingredientKey);
        render();
      }
    };

    // Initialize Data SDK
    async function initDataSdk() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error('Failed to initialize Data SDK');
      }
    }

    // Save recipe
    async function saveRecipe(recipeData) {
      if (recipes.length >= 999) {
        showError('Maximum limit of 999 recipes reached. Please delete some recipes first.');
        return;
      }

      isLoading = true;
      render();

      const recipe = {
        id: `recipe_${Date.now()}`,
        title: recipeData.title,
        category: recipeData.category,
        ingredients: recipeData.ingredients,
        instructions: recipeData.instructions,
        favorite: recipeData.favorite || false
      };

      const result = await window.dataSdk.create(recipe);
      isLoading = false;

      if (result.isOk) {
        currentView = 'recipes';
        editingRecipe = null;
      } else {
        showError('Failed to save recipe');
        render();
      }
    }

    // Update recipe
    async function updateRecipe(recipe) {
      isLoading = true;
      render();

      const result = await window.dataSdk.update(recipe);
      isLoading = false;

      if (result.isOk) {
        currentView = 'recipes';
        editingRecipe = null;
      } else {
        showError('Failed to update recipe');
        render();
      }
    }

    // Delete recipe
    async function deleteRecipe(recipe) {
      isLoading = true;
      render();

      const result = await window.dataSdk.delete(recipe);
      isLoading = false;

      if (!result.isOk) {
        showError('Failed to delete recipe');
        render();
      }
    }

    // Toggle favorite
    async function toggleFavorite(recipeId) {
      const recipe = getRecipeById(recipeId);
      if (!recipe) return;

      isLoading = true;
      render();

      const updatedRecipe = { ...recipe, favorite: !recipe.favorite };
      const result = await window.dataSdk.update(updatedRecipe);
      isLoading = false;

      if (!result.isOk) {
        showError('Failed to update favorite status');
        render();
      }
    }

    // Save plan
    async function savePlan(date, meal, recipeId) {
      const planId = `plan_${date}`;
      let plan = planData.find(p => p.date === date);
      
      isLoading = true;
      render();

      const mealKey = meal.toLowerCase();
      
      if (plan) {
        const updatedPlan = { ...plan, [mealKey]: recipeId };
        const result = await window.dataSdk.update(updatedPlan);
        isLoading = false;
        if (!result.isOk) {
          showError('Failed to update meal plan');
          render();
        }
      } else {
        if (planData.length >= 999) {
          isLoading = false;
          showError('Maximum limit of 999 plans reached');
          render();
          return;
        }
        const newPlan = {
          id: planId,
          date: date,
          breakfast: mealKey === 'breakfast' ? recipeId : null,
          lunch: mealKey === 'lunch' ? recipeId : null,
          dinner: mealKey === 'dinner' ? recipeId : null
        };
        const result = await window.dataSdk.create(newPlan);
        isLoading = false;
        if (!result.isOk) {
          showError('Failed to create meal plan');
          render();
        }
      }
    }

    // Remove meal from plan
    async function removeMealFromPlan(date, meal) {
      const plan = planData.find(p => p.date === date);
      if (!plan) return;

      isLoading = true;
      render();

      const mealKey = meal.toLowerCase();
      const updatedPlan = { ...plan, [mealKey]: null };
      const result = await window.dataSdk.update(updatedPlan);
      isLoading = false;

      if (!result.isOk) {
        showError('Failed to remove meal');
        render();
      }
    }

    // Toggle meal ingredient
    async function toggleMealIngredient(ingredientKey) {
      const selId = `mealSel_${selectedGroceryDate}_${selectedGroceryMeal}`;
      let sel = mealSelections.find(s => s.id === selId);
      
      let includedKeys = [];
      if (sel) {
        try { includedKeys = JSON.parse(sel.includedIngredientKeys || '[]'); }
        catch (e) { includedKeys = []; }
      }
      
      const index = includedKeys.indexOf(ingredientKey);
      if (index > -1) {
        includedKeys.splice(index, 1);
      } else {
        includedKeys.push(ingredientKey);
      }
      
      isLoading = true;
      render();

      if (sel) {
        const updatedSel = { ...sel, includedIngredientKeys: JSON.stringify(includedKeys) };
        const result = await window.dataSdk.update(updatedSel);
        isLoading = false;
        if (!result.isOk) {
          showError('Failed to update ingredient selection');
          render();
        }
      } else {
        if (mealSelections.length >= 999) {
          isLoading = false;
          showError('Maximum limit reached');
          render();
          return;
        }
        const newSel = {
          id: selId,
          mealDate: selectedGroceryDate,
          meal: selectedGroceryMeal,
          includedIngredientKeys: JSON.stringify(includedKeys)
        };
        const result = await window.dataSdk.create(newSel);
        isLoading = false;
        if (!result.isOk) {
          showError('Failed to create ingredient selection');
          render();
        }
      }
    }

    // Toggle grocery item
    async function toggleGroceryItem(ingredientKey) {
      let item = groceryItems.find(gi => gi.ingredientKey === ingredientKey);
      
      isLoading = true;
      render();

      if (item) {
        const updatedItem = { ...item, checked: !item.checked };
        const result = await window.dataSdk.update(updatedItem);
        isLoading = false;
        if (!result.isOk) {
          showError('Failed to update grocery item');
          render();
        }
      } else {
        if (groceryItems.length >= 999) {
          isLoading = false;
          showError('Maximum limit reached');
          render();
          return;
        }
        const newItem = {
          id: `grocery_${Date.now()}_${ingredientKey}`,
          ingredientKey: ingredientKey,
          checked: true
        };
        const result = await window.dataSdk.create(newItem);
        isLoading = false;
        if (!result.isOk) {
          showError('Failed to create grocery item');
          render();
        }
      }
    }

    // Open recipe picker
    function openRecipePicker(date, meal) {
      selectedDayForRecipe = date;
      selectedMealForRecipe = meal;
      currentView = 'recipe-picker';
      render();
    }

    // Open grocery ingredient picker
    function openGroceryIngredientPicker(date, meal, recipeId){
      selectedGroceryDate=date;
      selectedGroceryMeal=meal;
      selectedGroceryRecipeId=recipeId;

      (async()=>{
        const selId=`mealSel_${date}_${meal}`;
        let sel=mealSelections.find(s=>s.id===selId);
        if(!sel){
          const r=getRecipeById(recipeId);
          const keys=recipeIngList(r).map(x=>ingKey(x.name));
          sel={id:selId, mealDate:date, meal:meal, includedIngredientKeys:JSON.stringify(keys)};
          await window.dataSdk.create(sel);
          mealSelections.push(sel);
        }
        currentView='grocery-ingredients';
        render();
      })();
    }

    // Show error message
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-3 rounded shadow-lg z-50';
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);
      setTimeout(() => errorDiv.remove(), 3000);
    }

    // Navigation
    function navigateTo(view) {
      currentView = view;
      render();
    }

    function renderIngredientGrid() {
      if (!recipeForm) return '';

      return `
      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <label class="font-semibold" style="color:${config.text_color};">Ingredients</label>
          <button type="button" onclick="addIngRow()"
            class="px-3 py-2 rounded button-hover"
            style="background:${config.primary_action_color}; color:${config.text_color};">+ Add</button>
        </div>

        <div class="rounded overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
          <div class="grid" style="grid-template-columns:110px 120px 1fr 160px 56px; background:rgba(255,255,255,0.04);">
            <div class="p-3 font-semibold" style="color:${config.text_color}; opacity:.85;">Amt</div>
            <div class="p-3 font-semibold" style="color:${config.text_color}; opacity:.85;">Unit</div>
            <div class="p-3 font-semibold" style="color:${config.text_color}; opacity:.85;">Ingredient</div>
            <div class="p-3 font-semibold" style="color:${config.text_color}; opacity:.85;">Group</div>
            <div class="p-3"></div>
          </div>

          ${(recipeForm.ingredientsRows||[]).map((row,i)=>`
            <div class="grid items-center" style="grid-template-columns:110px 120px 1fr 160px 56px; border-top:1px solid rgba(255,255,255,0.06);">
              <div class="p-2">
                <input class="w-full px-3 py-2 rounded border"
                  style="background:rgba(0,0,0,0.16); color:${config.text_color}; border-color:rgba(255,255,255,0.10);"
                  value="${(row.qty||'').replaceAll('"','&quot;')}"
                  oninput="setIng(${i},'qty',this.value)" />
              </div>

              <div class="p-2">
                <input class="w-full px-3 py-2 rounded border" placeholder="e.g. lb"
                  style="background:rgba(0,0,0,0.16); color:${config.text_color}; border-color:rgba(255,255,255,0.10);"
                  value="${(row.unit||'').replaceAll('"','&quot;')}"
                  oninput="setIng(${i},'unit',this.value)" />
              </div>

              <div class="p-2">
                <input class="w-full px-3 py-2 rounded border" placeholder="e.g. Chicken breast"
                  style="background:rgba(0,0,0,0.16); color:${config.text_color}; border-color:rgba(255,255,255,0.10);"
                  value="${(row.name||'').replaceAll('"','&quot;')}"
                  oninput="setIng(${i},'name',this.value)" />
              </div>

              <div class="p-2">
                <select class="w-full px-3 py-2 rounded border"
                  style="background:rgba(0,0,0,0.16); color:${config.text_color}; border-color:rgba(255,255,255,0.10);"
                  onchange="setIng(${i},'group',this.value)">
                  ${ING_GROUPS.map(g=>`<option value="${g}" ${(row.group||'Produce')===g?'selected':''}>${g}</option>`).join('')}
                </select>
              </div>

              <div class="p-2 flex justify-center">
                <button type="button" onclick="delIngRow(${i})"
                  class="w-10 h-10 rounded button-hover"
                  style="background:rgba(220,38,38,0.75); color:white;">×</button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>`;
    }

    function renderRecipeEdit() {
      if (!recipeForm) return '';

      return `
      <div class="p-6 max-w-5xl mx-auto">
        <div class="flex items-center justify-between mb-6">
          <h2 class="font-bold" style="color:${config.text_color}; font-size:${config.font_size*1.6}px;">
            ${recipeForm.id ? 'Edit Recipe' : 'New Recipe'}
          </h2>
          <div class="flex gap-2">
            <button type="button" onclick="closeRecipeEditor()"
              class="px-4 py-2 rounded button-hover"
              style="background:${config.secondary_action_color}; color:${config.text_color};">Cancel</button>
            <button type="button" onclick="saveRecipeForm()"
              class="px-4 py-2 rounded button-hover"
              style="background:${config.primary_action_color}; color:${config.text_color};">Save</button>
          </div>
        </div>

        <div class="rounded p-6" style="background:${config.surface_color};">
          <label class="block mb-2 font-semibold" style="color:${config.text_color};">Recipe Title *</label>
          <input class="w-full px-4 py-3 rounded border"
            style="background:rgba(0,0,0,0.18); color:${config.text_color}; border-color:rgba(255,255,255,0.12);"
            value="${(recipeForm.title||'').replaceAll('"','&quot;')}"
            oninput="setRecipeField('title', this.value)" />

          <div class="grid md:grid-cols-2 gap-4 mt-5">
            <div>
              <label class="block mb-2 font-semibold" style="color:${config.text_color};">Category *</label>
              <select class="w-full px-4 py-3 rounded border"
                style="background:rgba(0,0,0,0.18); color:${config.text_color}; border-color:rgba(255,255,255,0.12);"
                onchange="setRecipeField('category', this.value)">
                ${['Breakfast','Lunch','Dinner','Snack','Dessert'].map(c=>`
                  <option value="${c}" ${recipeForm.category===c?'selected':''}>${c}</option>
                `).join('')}
              </select>
            </div>

            <div>
              <label class="block mb-2 font-semibold" style="color:${config.text_color};">Recipe URL *</label>
              <input class="w-full px-4 py-3 rounded border" placeholder="https://..."
                style="background:rgba(0,0,0,0.18); color:${config.text_color}; border-color:rgba(255,255,255,0.12);"
                value="${(recipeForm.recipe_url||'').replaceAll('"','&quot;')}"
                oninput="setRecipeField('recipe_url', this.value)" />
            </div>
          </div>

          <div class="mt-5">
            <label class="block mb-2 font-semibold" style="color:${config.text_color};">Image URL (optional)</label>
            <input class="w-full px-4 py-3 rounded border" placeholder="Paste image URL"
              style="background:rgba(0,0,0,0.18); color:${config.text_color}; border-color:rgba(255,255,255,0.12);"
              value="${(recipeForm.image_url||'').replaceAll('"','&quot;')}"
              oninput="setRecipeField('image_url', this.value)" />
            ${recipeForm.image_url ? `
              <div class="mt-4 rounded overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                <img src="${recipeForm.image_url}" style="width:100%; max-height:260px; object-fit:cover;" />
              </div>` : ``}
          </div>

          ${renderIngredientGrid()}

          <div class="mt-6">
            <label class="block mb-2 font-semibold" style="color:${config.text_color};">Tags (optional)</label>
            <input class="w-full px-4 py-3 rounded border" placeholder="e.g. Mediterranean, High Protein"
              style="background:rgba(0,0,0,0.18); color:${config.text_color}; border-color:rgba(255,255,255,0.12);"
              value="${(recipeForm.tags||'').replaceAll('"','&quot;')}"
              oninput="setRecipeField('tags', this.value)" />
          </div>

          <div class="mt-6">
            <label class="block mb-2 font-semibold" style="color:${config.text_color};">Step-by-step Instructions (optional)</label>
            <textarea class="w-full px-4 py-3 rounded border"
              style="background:rgba(0,0,0,0.18); color:${config.text_color}; border-color:rgba(255,255,255,0.12); min-height:120px;"
              placeholder="Enter cooking instructions..."
              oninput="setRecipeField('instructions', this.value)">${recipeForm.instructions||''}</textarea>
          </div>

          <div class="mt-6">
            <label class="block mb-2 font-semibold" style="color:${config.text_color};">Notes (optional)</label>
            <textarea class="w-full px-4 py-3 rounded border"
              style="background:rgba(0,0,0,0.18); color:${config.text_color}; border-color:rgba(255,255,255,0.12); min-height:120px;"
              oninput="setRecipeField('notes', this.value)">${recipeForm.notes||''}</textarea>
          </div>
        </div>
      </div>`;
    }

    // Render recipe picker
    function renderRecipePicker() {
      const filteredRecipes = recipes.filter(r => {
        if (filterFavorites && !r.favorite) return false;
        if (searchTerm && !r.title.toLowerCase().includes(searchTerm.toLowerCase())) return false;
        return r.category === selectedCategory;
      });

      return `
        <div class="p-6 max-w-6xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 style="color: ${config.text_color}; font-size: ${config.font_size * 1.5}px; font-family: ${config.font_family}, sans-serif;" class="font-bold">
              Select Recipe for ${formatDateDisplay(selectedDayForRecipe)} - ${selectedMealForRecipe}
            </h2>
            <button type="button" onclick="currentView='weekly-plan'; selectedDayForRecipe=null; selectedMealForRecipe=null; render();"
                    style="background: ${config.secondary_action_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                    class="px-4 py-2 rounded button-hover">
              Cancel
            </button>
          </div>

          <div class="mb-4 flex gap-4">
            <input type="text" placeholder="Search recipes..."
                   style="background: ${config.surface_color}; color: ${config.text_color}; border-color: ${config.secondary_action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                   class="flex-1 px-4 py-2 rounded border"
                   value="${searchTerm}"
                   oninput="searchTerm = this.value; render();">

            <label style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;" class="flex items-center gap-2">
              <input type="checkbox" ${filterFavorites ? 'checked' : ''}
                     onchange="filterFavorites = this.checked; render();">
              Favorites Only
            </label>
          </div>

          <div class="flex gap-2 mb-6 flex-wrap">
            ${['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Dessert'].map(cat => `
              <button type="button" onclick="selectedCategory='${cat}'; render();"
                      style="background: ${selectedCategory === cat ? config.primary_action_color : config.secondary_action_color};
                             color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="px-4 py-2 rounded button-hover">
                ${cat}
              </button>
            `).join('')}
          </div>

          <div class="grid gap-3">
            ${filteredRecipes.length === 0 ? `
              <div style="background: ${config.surface_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                   class="p-8 rounded text-center">
                No recipes found
              </div>
            ` : filteredRecipes.map(recipe => `
              <button type="button"
                      onclick="handleRecipePickerSelect('${recipe.__backendId || recipe.id}')"
                      style="background: ${config.surface_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="p-4 rounded card-hover text-left w-full flex items-center justify-between">
                <div class="flex items-center gap-4">
                  ${recipe.favorite ? '<span style="font-size: 1.25rem;">⭐</span>' : ''}
                  <div>
                    <div class="font-semibold" style="font-size: ${config.font_size * 1.125}px;">${recipe.title}</div>
                    <div style="opacity: 0.7; font-size: ${config.font_size * 0.875}px;">${recipe.category}</div>
                  </div>
                </div>
                <div style="color: ${config.primary_action_color}; font-size: ${config.font_size}px;">Select →</div>
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Handle recipe picker selection
    async function handleRecipePickerSelect(recipeId) {
      await savePlan(selectedDayForRecipe, selectedMealForRecipe, recipeId);
      selectedDayForRecipe = null;
      selectedMealForRecipe = null;
      currentView = 'weekly-plan';
      render();
    }

    // Render grocery ingredients picker
    function renderGroceryIngredients(){
      const r=getRecipeById(selectedGroceryRecipeId);
      if(!r) return `<div class="p-6">Recipe not found</div>`;

      const list=recipeIngList(r);
      const selId=`mealSel_${selectedGroceryDate}_${selectedGroceryMeal}`;
      const sel=mealSelections.find(s=>s.id===selId);

      let keys=[];
      try{keys=sel?JSON.parse(sel.includedIngredientKeys||'[]'):list.map(x=>ingKey(x.name));}
      catch(e){keys=list.map(x=>ingKey(x.name));}

      return `
      <div class="p-6 max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="font-bold" style="color:${config.text_color}; font-size:${config.font_size*1.5}px;">Choose Ingredients</h2>
            <p style="color:${config.text_color}; opacity:.7; font-size:${config.font_size*.9}px;">
              ${esc(r.title)} • ${formatDateDisplay(selectedGroceryDate)} ${esc(selectedGroceryMeal)}
            </p>
          </div>
          <button type="button" onclick="currentView='grocery-list'; render();"
            class="px-4 py-2 rounded button-hover"
            style="background:${config.primary_action_color}; color:${config.text_color}; font-size:${config.font_size}px;">
            Done
          </button>
        </div>

        <div class="rounded p-4" style="background:${config.surface_color};">
          ${list.length?list.map(ing=>{
            const k=ingKey(ing.name);
            const checked=keys.includes(k);
            return `
            <label class="flex items-center justify-between gap-3 p-3 rounded mb-2"
              style="background:rgba(255,255,255,0.04); color:${config.text_color}; font-size:${config.font_size}px;">
              <div class="flex items-center gap-3">
                <input type="checkbox" ${checked?'checked':''}
                  onchange="toggleMealIngredient('${k}')" />
                <span>${esc(ing.qty)}${ing.unit?' '+esc(ing.unit):''} ${esc(ing.name)}</span>
              </div>
            </label>`;
          }).join(''):`<div style="color:${config.text_color};opacity:.7;">No ingredients on this recipe yet.</div>`}
        </div>
      </div>`;
    }

    // Render grocery select meals view
    function renderGrocerySelectMeals() {
      const plannedMeals = getPlannedMealsForWeek(currentWeekStartDate);

      return `
        <div class="p-6 max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 style="color: ${config.text_color}; font-size: ${config.font_size * 1.5}px; font-family: ${config.font_family}, sans-serif;" class="font-bold">
              Select Meals for Grocery List
            </h2>
            <button type="button" onclick="currentView='grocery-list'; render();"
                    style="background: ${config.primary_action_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                    class="px-4 py-2 rounded button-hover">
              Done
            </button>
          </div>

          ${plannedMeals.length === 0 ? `
            <div style="background: ${config.surface_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                 class="p-8 rounded text-center">
              No meals planned for this week
            </div>
          ` : `
            <div class="grid gap-3">
              ${plannedMeals.map(meal => `
                <div style="background: ${config.surface_color};" class="p-4 rounded card-hover flex items-center justify-between">
                  <div>
                    <div style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.125}px;" class="font-semibold">
                      ${meal.recipeTitle}
                    </div>
                    <div style="color: ${config.text_color}; opacity: 0.7; font-size: ${config.font_size * 0.875}px; font-family: ${config.font_family}, sans-serif;">
                      ${formatDateDisplay(meal.date)} - ${meal.meal}
                    </div>
                  </div>
                  <button type="button" onclick="openGroceryIngredientPicker('${meal.date}', '${meal.meal}', '${meal.recipeId}')"
                          style="background: ${config.primary_action_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                          class="px-4 py-2 rounded button-hover">
                    Choose Ingredients
                  </button>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    // Render weekly plan
    function renderWeeklyPlan(){
      const weekDates=getWeekDates(currentWeekStartDate);
      const meals=['Breakfast','Lunch','Dinner'];

      return `
      <div class="p-6 max-w-7xl mx-auto">
        <div class="flex items-center justify-between mb-6">
          <h2 class="font-bold" style="color:${config.text_color}; font-size:${config.font_size*1.5}px;">
            ${config.weekly_plan_label}
          </h2>
          <div class="flex gap-2">
            <button type="button" onclick="changeWeek(-1)" class="px-4 py-2 rounded button-hover"
              style="background:${config.secondary_action_color}; color:${config.text_color}; font-size:${config.font_size}px;">← Previous</button>
            <button type="button" onclick="changeWeek(1)" class="px-4 py-2 rounded button-hover"
              style="background:${config.secondary_action_color}; color:${config.text_color}; font-size:${config.font_size}px;">Next →</button>
          </div>
        </div>

        <div class="grid gap-4">
          ${weekDates.map(date=>{
            const plan=planData.find(p=>p.date===date);
            return `
            <div class="rounded p-4" style="background:${config.surface_color};">
              <div class="font-semibold mb-3" style="color:${config.text_color}; font-size:${config.font_size*1.1}px;">
                ${formatDateDisplay(date)}
              </div>
              <div class="grid gap-2">
                ${meals.map(meal=>{
                  const key=meal.toLowerCase();
                  const rid=plan?plan[key]:null;
                  const r=rid?getRecipeById(rid):null;
                  const img=r?recipeThumb(r):'';
                  const url=r?(r.recipe_url||'').trim():'';
                  const linkStart=url?`<a href="${esc(url)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();" class="flex items-center gap-3">`:`<div class="flex items-center gap-3">`;
                  const linkEnd=url?`</a>`:`</div>`;

                  return `
                  <div class="flex items-center justify-between p-3 rounded" style="background:rgba(255,255,255,0.03);">
                    ${linkStart}
                      ${img?`<img src="${esc(img)}" style="width:42px;height:42px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,0.08);" />`
                           :`<div style="width:42px;height:42px;border-radius:10px;background:rgba(255,255,255,0.06);"></div>`}
                      <div>
                        <div style="color:${config.text_color}; opacity:.7; font-size:${config.font_size*.85}px;">${meal}</div>
                        <div style="color:${config.text_color}; font-size:${config.font_size}px;">
                          ${r?esc(r.title):'<span style="opacity:.5;">No meal planned</span>'}
                        </div>
                      </div>
                    ${linkEnd}

                    <div class="flex gap-2">
                      ${r?`
                        <button type="button" onclick="event.stopPropagation(); openRecipeView('${r.__backendId||r.id}')"
                          class="px-3 py-1 rounded button-hover"
                          style="background:${config.secondary_action_color}; color:${config.text_color}; font-size:${config.font_size*.85}px;">
                          View
                        </button>
                        <button type="button" onclick="event.stopPropagation(); removeMealFromPlan('${date}','${meal}')"
                          class="px-3 py-1 rounded button-hover"
                          style="background:#dc2626;color:white;font-size:${config.font_size*.85}px;">
                          Remove
                        </button>`:''}

                      <button type="button" onclick="event.stopPropagation(); openRecipePicker('${date}','${meal}')"
                        class="px-3 py-1 rounded button-hover"
                        style="background:${config.primary_action_color};color:${config.text_color};font-size:${config.font_size*.85}px;">
                        ${r?'Change':'Add'}
                      </button>
                    </div>
                  </div>`;
                }).join('')}
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    }

    // Change week
    function changeWeek(direction) {
      const date = new Date(currentWeekStartDate);
      date.setDate(date.getDate() + (direction * 7));
      currentWeekStartDate = date.toISOString().split('T')[0];
      render();
    }

    // Render grocery list
    function renderGroceryList() {
      const groceryList = getGroceryList();
      const unchecked = groceryList.filter(item => !item.checked);
      const checked = groceryList.filter(item => item.checked);

      return `
        <div class="p-6 max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 style="color: ${config.text_color}; font-size: ${config.font_size * 1.5}px; font-family: ${config.font_family}, sans-serif;" class="font-bold">
              ${config.grocery_list_label}
            </h2>
            <button type="button" onclick="currentView='grocery-select-meals'; render();"
                    style="background: ${config.primary_action_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                    class="px-4 py-2 rounded button-hover">
              Select Meals
            </button>
          </div>

          ${groceryList.length === 0 ? `
            <div style="background: ${config.surface_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                 class="p-8 rounded text-center">
              No ingredients selected. Click "Select Meals" to add items to your grocery list.
            </div>
          ` : `
            <div style="background: ${config.surface_color};" class="rounded p-4">
              ${unchecked.length > 0 ? `
                <div class="mb-4">
                  <h3 style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.125}px;" class="font-semibold mb-2">
                    To Buy
                  </h3>
                  ${unchecked.map(item => `
                    <label style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                           class="flex items-center gap-3 p-3 rounded hover:bg-opacity-50 cursor-pointer">
                      <input type="checkbox" onchange="toggleGroceryItem('${normalizeIngredient(item.name)}')">
                      <span>${item.quantity} ${item.unit} ${item.name}</span>
                    </label>
                  `).join('')}
                </div>
              ` : ''}

              ${checked.length > 0 ? `
                <div>
                  <h3 style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.125}px;" class="font-semibold mb-2">
                    Checked Off
                  </h3>
                  ${checked.map(item => `
                    <label style="color: ${config.text_color}; opacity: 0.5; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                           class="flex items-center gap-3 p-3 rounded hover:bg-opacity-50 cursor-pointer line-through">
                      <input type="checkbox" checked onchange="toggleGroceryItem('${normalizeIngredient(item.name)}')">
                      <span>${item.quantity} ${item.unit} ${item.name}</span>
                    </label>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `}
        </div>
      `;
    }

    // Render home view
    function renderHome() {
      return `
        <div class="p-6 max-w-6xl mx-auto">
          <h1 style="color: ${config.text_color}; font-size: ${config.font_size * 2}px; font-family: ${config.font_family}, sans-serif;"
              class="app-title mb-8 text-center">
            ${config.app_title}
          </h1>

          <div class="grid md:grid-cols-3 gap-6">
            <button type="button" onclick="navigateTo('recipes')"
                    style="background: ${config.surface_color};"
                    class="p-8 rounded-lg card-hover text-center">
              <div style="font-size: 3rem;" class="mb-4">🍳</div>
              <h3 style="color: ${config.text_color}; font-size: ${config.font_size * 1.25}px; font-family: ${config.font_family}, sans-serif;"
                  class="font-bold mb-2">
                ${config.recipes_label}
              </h3>
              <p style="color: ${config.text_color}; opacity: 0.7; font-size: ${config.font_size}px; font-family: ${config.font_family}, sans-serif;">
                Browse and manage your recipe collection
              </p>
            </button>

            <button type="button" onclick="navigateTo('weekly-plan')"
                    style="background: ${config.surface_color};"
                    class="p-8 rounded-lg card-hover text-center">
              <div style="font-size: 3rem;" class="mb-4">📅</div>
              <h3 style="color: ${config.text_color}; font-size: ${config.font_size * 1.25}px; font-family: ${config.font_family}, sans-serif;"
                  class="font-bold mb-2">
                ${config.weekly_plan_label}
              </h3>
              <p style="color: ${config.text_color}; opacity: 0.7; font-size: ${config.font_size}px; font-family: ${config.font_family}, sans-serif;">
                Plan your meals for the week
              </p>
            </button>

            <button type="button" onclick="navigateTo('grocery-list')"
                    style="background: ${config.surface_color};"
                    class="p-8 rounded-lg card-hover text-center">
              <div style="font-size: 3rem;" class="mb-4">🛒</div>
              <h3 style="color: ${config.text_color}; font-size: ${config.font_size * 1.25}px; font-family: ${config.font_family}, sans-serif;"
                  class="font-bold mb-2">
                ${config.grocery_list_label}
              </h3>
              <p style="color: ${config.text_color}; opacity: 0.7; font-size: ${config.font_size}px; font-family: ${config.font_family}, sans-serif;">
                Generate shopping list from your plan
              </p>
            </button>
          </div>
        </div>
      `;
    }

    // Render recipes view
    function renderRecipes(){
      const cats=['Breakfast','Lunch','Dinner','Snack','Dessert'];
      const list=recipes.filter(r=>{
        if(filterFavorites && !r.favorite) return false;
        if(selectedCategory && r.category!==selectedCategory) return false;
        if(searchTerm && !(r.title||'').toLowerCase().includes(searchTerm.toLowerCase())) return false;
        return true;
      });

      return `
      <div class="p-6 max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-bold" style="color:${config.text_color}; font-size:${config.font_size*1.5}px;">
            ${config.recipes_label}
          </h2>
          <button type="button" onclick="openNewRecipe()"
            class="px-4 py-2 rounded button-hover"
            style="background:${config.primary_action_color}; color:${config.text_color}; font-size:${config.font_size}px;">
            + Add Recipe
          </button>
        </div>

        <div class="flex flex-wrap gap-2 mb-3">
          ${cats.map(c=>`
            <button type="button" onclick="selectedCategory='${c}'; render();"
              class="px-3 py-2 rounded button-hover"
              style="background:${selectedCategory===c?config.primary_action_color:config.secondary_action_color};
              color:${config.text_color}; font-size:${config.font_size}px;">${c}</button>`).join('')}
          <label class="flex items-center gap-2 px-3 py-2 rounded"
            style="background:${config.surface_color}; color:${config.text_color};">
            <input type="checkbox" ${filterFavorites?'checked':''}
              onchange="filterFavorites=this.checked; render();"> Favorites
          </label>
        </div>

        <input placeholder="Search recipes..."
          class="w-full px-4 py-2 rounded border mb-5"
          style="background:${config.surface_color}; color:${config.text_color}; border-color:${config.secondary_action_color};"
          value="${esc(searchTerm)}"
          oninput="searchTerm=this.value; render();"/>

        ${list.length===0?`
          <div class="p-8 rounded text-center" style="background:${config.surface_color}; color:${config.text_color};">
            No recipes found.
          </div>`:`
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${list.map(r=>{
              const id=(r.__backendId||r.id);
              const img=recipeThumb(r);
              return `
              <div class="rounded-lg p-4 card-hover cursor-pointer"
                onclick="openRecipeView('${id}')"
                style="background:${config.surface_color};">
                ${img?`<div class="mb-3 rounded overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                  <img src="${esc(img)}" style="width:100%; height:120px; object-fit:cover;" />
                </div>`:''}

                <div class="flex items-start justify-between gap-2 mb-2">
                  <div>
                    <div class="font-semibold" style="color:${config.text_color}; font-size:${config.font_size*1.1}px;">
                      ${esc(r.title)}
                    </div>
                    <div style="color:${config.text_color}; opacity:.7; font-size:${config.font_size*.9}px;">
                      ${esc(r.category)}
                    </div>
                  </div>
                  <button type="button" class="text-2xl"
                    onclick="event.stopPropagation(); toggleFavorite('${id}')">
                    ${r.favorite?'⭐':'☆'}
                  </button>
                </div>

                <div class="flex gap-2 mt-3">
                  <button type="button"
                    onclick="event.stopPropagation(); openEditRecipe('${id}')"
                    class="flex-1 px-3 py-2 rounded button-hover"
                    style="background:${config.primary_action_color}; color:${config.text_color}; font-size:${config.font_size*.9}px;">
                    Edit
                  </button>
                  <button type="button"
                    onclick="event.stopPropagation(); if(confirm('Delete this recipe?')) deleteRecipe(recipes.find(x=>(x.__backendId||x.id)==='${id}'))"
                    class="flex-1 px-3 py-2 rounded button-hover"
                    style="background:#dc2626; color:white; font-size:${config.font_size*.9}px;">
                    Delete
                  </button>
                </div>
              </div>`;
            }).join('')}
          </div>`}
      </div>`;
    }

    // Render recipe form
    function renderRecipeForm() {
      const isEditing = editingRecipe && editingRecipe.__backendId;
      const recipe = isEditing ? editingRecipe : {
        title: '',
        category: 'Breakfast',
        ingredients: '',
        instructions: '',
        favorite: false
      };

      return `
        <div class="p-6 max-w-3xl mx-auto">
          <h2 style="color: ${config.text_color}; font-size: ${config.font_size * 1.5}px; font-family: ${config.font_family}, sans-serif;"
              class="font-bold mb-6">
            ${isEditing ? 'Edit Recipe' : 'New Recipe'}
          </h2>

          <form onsubmit="event.preventDefault(); handleRecipeSubmit(event);"
                style="background: ${config.surface_color};"
                class="rounded-lg p-6 space-y-4">
            
            <div>
              <label style="color: ${config.text_color}; font-size: ${config.font_size}px; font-family: ${config.font_family}, sans-serif;"
                     class="block mb-2">
                Recipe Title
              </label>
              <input type="text" name="title" required
                     value="${recipe.title}"
                     style="background: ${config.background_color}; color: ${config.text_color}; border-color: ${config.secondary_action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                     class="w-full px-4 py-2 rounded border">
            </div>

            <div>
              <label style="color: ${config.text_color}; font-size: ${config.font_size}px; font-family: ${config.font_family}, sans-serif;"
                     class="block mb-2">
                Category
              </label>
              <select name="category"
                      style="background: ${config.background_color}; color: ${config.text_color}; border-color: ${config.secondary_action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="w-full px-4 py-2 rounded border">
                ${['Breakfast', 'Lunch', 'Dinner', 'Snack', 'Dessert'].map(cat => `
                  <option value="${cat}" ${recipe.category === cat ? 'selected' : ''}>${cat}</option>
                `).join('')}
              </select>
            </div>

            <div>
              <label style="color: ${config.text_color}; font-size: ${config.font_size}px; font-family: ${config.font_family}, sans-serif;"
                     class="block mb-2">
                Ingredients (one per line)
              </label>
              <textarea name="ingredients" required rows="6"
                        style="background: ${config.background_color}; color: ${config.text_color}; border-color: ${config.secondary_action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                        class="w-full px-4 py-2 rounded border">${recipe.ingredients}</textarea>
            </div>

            <div>
              <label style="color: ${config.text_color}; font-size: ${config.font_size}px; font-family: ${config.font_family}, sans-serif;"
                     class="block mb-2">
                Instructions
              </label>
              <textarea name="instructions" required rows="8"
                        style="background: ${config.background_color}; color: ${config.text_color}; border-color: ${config.secondary_action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                        class="w-full px-4 py-2 rounded border">${recipe.instructions}</textarea>
            </div>

            <label style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                   class="flex items-center gap-2">
              <input type="checkbox" name="favorite" ${recipe.favorite ? 'checked' : ''}>
              Mark as favorite
            </label>

            <div class="flex gap-3 pt-4">
              <button type="submit"
                      style="background: ${config.primary_action_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="flex-1 px-4 py-2 rounded button-hover"
                      ${isLoading ? 'disabled' : ''}>
                ${isLoading ? 'Saving...' : (isEditing ? 'Update Recipe' : 'Add Recipe')}
              </button>
              <button type="button" onclick="currentView = 'recipes'; editingRecipe = null; render();"
                      style="background: ${config.secondary_action_color}; color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="flex-1 px-4 py-2 rounded button-hover">
                Cancel
              </button>
            </div>
          </form>
        </div>
      `;
    }

    // Handle recipe form submit
    async function handleRecipeSubmit(event) {
      const formData = new FormData(event.target);
      const recipeData = {
        title: formData.get('title'),
        category: formData.get('category'),
        ingredients: formData.get('ingredients'),
        instructions: formData.get('instructions'),
        favorite: formData.get('favorite') === 'on'
      };

      if (editingRecipe && editingRecipe.__backendId) {
        await updateRecipe({ ...editingRecipe, ...recipeData });
      } else {
        await saveRecipe(recipeData);
      }
    }

    // Main render function
    function render() {
      const app = document.getElementById('app');
      
      let content = '';
      switch (currentView) {
        case 'home':
          content = renderHome();
          break;
        case 'recipes':
          content = renderRecipes();
          break;
        case 'recipe-form':
          content = renderRecipeForm();
          break;
        case 'recipe-edit':
          content = renderRecipeEdit();
          break;
        case 'recipe-view':
          content = renderRecipeView();
          break;
        case 'weekly-plan':
          content = renderWeeklyPlan();
          break;
        case 'recipe-picker':
          content = renderRecipePicker();
          break;
        case 'grocery-list':
          content = renderGroceryList();
          break;
        case 'grocery-select-meals':
          content = renderGrocerySelectMeals();
          break;
        case 'grocery-ingredients':
          content = renderGroceryIngredients();
          break;
        default:
          content = renderHome();
      }

      const nav = currentView !== 'home' ? `
        <nav style="background: ${config.surface_color};" class="p-4 mb-0">
          <div class="max-w-7xl mx-auto flex items-center justify-between">
            <button type="button" onclick="navigateTo('home')"
                    style="color: ${config.text_color}; font-size: ${config.font_size * 1.25}px; font-family: ${config.font_family}, sans-serif;"
                    class="font-bold button-hover">
              ${config.app_title}
            </button>
            <div class="flex gap-4">
              <button type="button" onclick="navigateTo('recipes')"
                      style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="button-hover ${currentView.includes('recipe') ? 'font-bold' : ''}">
                ${config.recipes_label}
              </button>
              <button type="button" onclick="navigateTo('weekly-plan')"
                      style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="button-hover ${currentView === 'weekly-plan' ? 'font-bold' : ''}">
                ${config.weekly_plan_label}
              </button>
              <button type="button" onclick="navigateTo('grocery-list')"
                      style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;"
                      class="button-hover ${currentView.includes('grocery') ? 'font-bold' : ''}">
                ${config.grocery_list_label}
              </button>
            </div>
          </div>
        </nav>
      ` : '';

      app.innerHTML = `
        <div style="background: ${config.background_color}; min-height: 100%;">
          ${nav}
          ${content}
        </div>
      `;
    }

    // Element SDK configuration
    let config = { ...defaultConfig };

    const element = {
      defaultConfig,
      onConfigChange: async (newConfig) => {
        config = { ...newConfig };
        render();
      },
      mapToCapabilities: (config) => ({
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.primary_action_color || defaultConfig.primary_action_color,
            set: (value) => {
              config.primary_action_color = value;
              window.elementSdk.setConfig({ primary_action_color: value });
            }
          },
          {
            get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
            set: (value) => {
              config.secondary_action_color = value;
              window.elementSdk.setConfig({ secondary_action_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      }),
      mapToEditPanelValues: (config) => new Map([
        ['app_title', config.app_title || defaultConfig.app_title],
        ['recipes_label', config.recipes_label || defaultConfig.recipes_label],
        ['weekly_plan_label', config.weekly_plan_label || defaultConfig.weekly_plan_label],
        ['grocery_list_label', config.grocery_list_label || defaultConfig.grocery_list_label]
      ])
    };

    // Initialize
    async function init() {
      if (window.elementSdk) {
        await window.elementSdk.init(element);
        config = window.elementSdk.config;
      }
      
      await initDataSdk();
      render();
    }

    init();
  </script>
  </body>
</html>
